# 要件

- 統合開発環境に VScode を使用
- Docker for Desktop をインストール済みであること
<br>
<br>

# Wordpress 環境の構築

## 1.リモートリポジトリよりクローン

任意のディレクトリにリポジトリをクローンする。

## 2.プラグインのインストール・有効化

プロジェクトを VScode より起動すると、推奨プラグインをインストールするサジェストが表示されるので、インストール・有効化する。  
※サジェストがない婆は左ペインの「拡張機能」より推奨プラグインをインストールする。

## 3.環境変数の格納ファイルを設置

.envファイル （git管理外）をルートディレクトリに配置

## 4.イメージ生成/コンテナ起動

下記コマンドより、イメージ生成 → コンテナ起動を実行する

```
docker-compose up -d
```

上記のコマンドでコンテナが正常に起動しない or エラーが生じる等の場合は、下記の項目に該当しないかチェックする

- 環境構築に用いるファイルの改行コードが lf になっているか。（crlf だと正常に起動できない場合がある）  
  ※vscode のプラグイン「editorconfig」が入っていれば、保存時（Ctrl+s）に整形処理が働く
- 他ツールの仮想環境で使用中のポート番号と重複していないか
- 環境構築に必要なファイルに不足はないか。

※設定ファイルに変更を加えた場合は下記コマンドで再立ち上げする  

```
docker-compose up -d --build
```

## 5.仮のサイト情報を設定する

docker for desctop の wordpress コンテナに指定されているポート番号へアクセスし、言語設定や任意のユーザ名、パス、サイト情報を登録し、管理画面へアクセスする。
※後述するバックアップファイルのインポートでこの設定内容は上書きされるので、仮のものと考えて良い。

## 6.プラグインのインストール

管理画面左ペインより、「プラグイン(plugin)」を選択し、「新規プラグインを追加」で「all in one wp-migration」を検索、インストール、有効化する

## 7.バックアップファイルのインポート

「All-in-one WP Migration」>> 「インポート」より、DB、メディア、プラグイン、記事情報等を含んだバックアップファイルファイル指定する。  
※このバックアップファイルにテーマファイルが含まれていると、theme 配下の.git が消えてしまうため、バックアップファイルにテーマファイルは含めないこと。

## 8.再ログイン

インポート後はブラウザを再読み込みし、.envに記載されたユーザ名、パスワードを入力する。  
各ページが問題なく表示できていれば環境構築完了
<br>
<br>

# バックアップファイルの作成

プラグイン情報やフィールドの追加など、DB まわりの修正が行われた場合は、バックアップファイルを生成し、Backlog などで更新・管理すること。

◾️ バックアップファイルの作成  
1.「All-in-one WP Migration」>> 「エクスポート」  
2.「高度なオプション」より「テーマをエクスポートしない」にチェックをいれる  
※テーマ配下のコードは Git で取得可能かつ BP ファイルのインストール先で.git を上書いて消してしまうため、エクスポート対象からテーマを外すこと。  
3.生成したBPファイルはドキュメントルートに残しておく。

※ All in one wp-migrationがファイル権限でエラーを起こして使用できない場合、所有者、所有者グループが原因の可能性がある.
wordpressコンテナ内のpluginフォルダを参照し、所有者、所有者グループがrootになっていないかを確認し、必要に応じて下記コマンドを実行する。  


```
chown -R www-data:www-data /var/www/html/wp-content/plugins/*
```
※所有者グループと所有者を変更

# テーマ開発環境の構築

Dev Containers をインストールすることで、VScode 上からコンテナ環境へ容易にアクセスすることができるようになっている。

## 1.リモートウィンドウを開く

VScode の左下緑ボタンよりコンテナ内のフォルダを開く

## 2.開発モードによる作業

### 2.1 設定変更

functions.php の IS_VITE_DEVELOPMENT が'true'になっていることを確認する。なっていなければ'true'に変更する。

### 2.2 開発モードでモジュールバンドラーを起動

下記コマンドを実行するとポートが解放されるので開いておき、theme 配下の修正を進める。

```
npm run dev
```

※ Wordpress コンテナのポートを参照しながら改修作業を進める。
※上記のコマンドで開放されたポートはブラウザ表示とは直結しないが、バンドル作業の実行に必要となるため開いておく

下記コマンドで stylint によるチェックを実施できるので、改修後に実行してデバッグする。

```
npm run lint:style
```

## 3.本番アップロード用ファイルの生成

### 3.1 設定変更

functions.php の IS_VITE_DEVELOPMENT を'false'に設定

### 3.2 本番モードでモジュールバンドラーを起動

下記コマンドを実行することで、本番用のアセット資源が dist フォルダ内に格納される。

```
npm run build
```
